USE [IDMAKER]
GO
/****** Object:  Trigger [dmkr_asline].[JOBS_AUPD_TRG]    Script Date: 11/30/2017 12:12:37 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dmkr_asline].[JOBS_AUPD_TRG] 
   ON [dmkr_asline].[JOBS]
      AFTER UPDATE AS 
BEGIN
   SET NOCOUNT ON

   DECLARE 
      @NEW_JOB_ID BIGINT , 
      @NEW_JOBSTATUS NUMERIC (10) , 
      @NEW_JOBENDTIME DATETIME , 
      @NEW_JOBERR_ID BIGINT , 
      @NEW_JOBTRNTOTAL BIGINT , 
      @NEW_JOBTRNWIP BIGINT , 
      @NEW_JOBTRNERR BIGINT , 
      @NEW_JOBTRNSCH BIGINT ,
      @NEW_JOBTRNPROC BIGINT ,
      @NEW_JOBTRNSTARTTIME DATETIME , 
      @NEW_JOBTRNENDTIME DATETIME , 
      @NEW_JOBRCPTOTAL BIGINT , 
      @NEW_JOBRCPERR BIGINT , 
      @NEW_JOBRCPSCH BIGINT ,
      @NEW_JOBRCPPROC BIGINT ,
      @NEW_JOBRCPSTARTTIME DATETIME , 
      @NEW_JOBRCPENDTIME DATETIME , 
      @NEW_JOBBCHTOTAL BIGINT , 
      @NEW_JOBBCHERR BIGINT , 
      @NEW_JOBBCHSCH BIGINT ,
      @NEW_JOBBCHPROC BIGINT ,
      @NEW_JOBBCHSTARTTIME DATETIME , 
      @NEW_JOBBCHENDTIME DATETIME , 
      @NEW_JOBREPLYSENT NUMERIC (5) ,
      @NEW_JOBREPLYSENTTIME DATETIME ,
      @OLD_JOBSTATUS NUMERIC (10) , 
      @OLD_JOBENDTIME DATETIME , 
      @OLD_JOBERR_ID BIGINT , 
      @OLD_JOBTRNTOTAL BIGINT , 
      @OLD_JOBTRNWIP BIGINT , 
      @OLD_JOBTRNERR BIGINT , 
      @OLD_JOBTRNSCH BIGINT ,
      @OLD_JOBTRNPROC BIGINT ,
      @OLD_JOBTRNSTARTTIME DATETIME , 
      @OLD_JOBTRNENDTIME DATETIME , 
      @OLD_JOBRCPTOTAL BIGINT , 
      @OLD_JOBRCPERR BIGINT , 
      @OLD_JOBRCPSCH BIGINT ,
      @OLD_JOBRCPPROC BIGINT ,
      @OLD_JOBRCPSTARTTIME DATETIME , 
      @OLD_JOBRCPENDTIME DATETIME , 
      @OLD_JOBBCHTOTAL BIGINT , 
      @OLD_JOBBCHERR BIGINT , 
      @OLD_JOBBCHSCH BIGINT ,
      @OLD_JOBBCHPROC BIGINT ,
      @OLD_JOBBCHSTARTTIME DATETIME , 
      @OLD_JOBBCHENDTIME DATETIME , 
      @OLD_JOBREPLYSENT NUMERIC (5) ,
      @OLD_JOBREPLYSENTTIME DATETIME 

   BEGIN
      DECLARE JOBS_AUPD_TRG_CUR CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT 
            [I].[JOB_ID] , 
            [I].[JOBSTATUS] , 
            [I].[JOBENDTIME] , 
            [I].[JOBERR_ID] , 
            [I].[JOBTRNTOTAL] , 
            [I].[JOBTRNWIP] , 
            [I].[JOBTRNERR] , 
            [I].[JOBTRNSCH] ,
            [I].[JOBTRNPROC] ,
            [I].[JOBTRNSTARTTIME] , 
            [I].[JOBTRNENDTIME] , 
            [I].[JOBRCPTOTAL] , 
            [I].[JOBRCPERR] , 
            [I].[JOBRCPSCH] ,
            [I].[JOBRCPPROC] ,
            [I].[JOBRCPSTARTTIME] , 
            [I].[JOBRCPENDTIME] , 
            [I].[JOBBCHTOTAL] , 
            [I].[JOBBCHERR] , 
            [I].[JOBBCHSCH] ,
            [I].[JOBBCHPROC] ,
            [I].[JOBBCHSTARTTIME] , 
            [I].[JOBBCHENDTIME] , 
            [I].[JOBREPLYSENT] ,
            [I].[JOBREPLYSENTTIME] 
         FROM [INSERTED] AS [I]

         OPEN JOBS_AUPD_TRG_CUR

         FETCH NEXT FROM JOBS_AUPD_TRG_CUR INTO
            @NEW_JOB_ID , 
            @NEW_JOBSTATUS , 
            @NEW_JOBENDTIME , 
            @NEW_JOBERR_ID , 
            @NEW_JOBTRNTOTAL , 
            @NEW_JOBTRNWIP , 
            @NEW_JOBTRNERR , 
            @NEW_JOBTRNSCH ,
            @NEW_JOBTRNPROC ,
            @NEW_JOBTRNSTARTTIME , 
            @NEW_JOBTRNENDTIME , 
            @NEW_JOBRCPTOTAL , 
            @NEW_JOBRCPERR , 
            @NEW_JOBRCPSCH ,
            @NEW_JOBRCPPROC ,
            @NEW_JOBRCPSTARTTIME , 
            @NEW_JOBRCPENDTIME , 
            @NEW_JOBBCHTOTAL , 
            @NEW_JOBBCHERR , 
            @NEW_JOBBCHSCH ,
            @NEW_JOBBCHPROC ,
            @NEW_JOBBCHSTARTTIME , 
            @NEW_JOBBCHENDTIME , 
            @NEW_JOBREPLYSENT ,
            @NEW_JOBREPLYSENTTIME 

         WHILE @@FETCH_STATUS = 0
         BEGIN
            SELECT 
               @OLD_JOBSTATUS=[D].[JOBSTATUS] ,
               @OLD_JOBENDTIME=[D].[JOBENDTIME] ,
               @OLD_JOBERR_ID=[D].[JOBERR_ID] ,
               @OLD_JOBTRNTOTAL=[D].[JOBTRNTOTAL] ,
               @OLD_JOBTRNWIP=[D].[JOBTRNWIP] ,
               @OLD_JOBTRNERR=[D].[JOBTRNERR] ,
               @OLD_JOBTRNSCH=[D].[JOBTRNSCH] ,
               @OLD_JOBTRNPROC=[D].[JOBTRNPROC] ,
               @OLD_JOBTRNSTARTTIME=[D].[JOBTRNSTARTTIME] ,
               @OLD_JOBTRNENDTIME=[D].[JOBTRNENDTIME] ,
               @OLD_JOBRCPTOTAL=[D].[JOBRCPTOTAL] ,
               @OLD_JOBRCPERR=[D].[JOBRCPERR] ,
               @OLD_JOBRCPSCH=[D].[JOBRCPSCH] ,
               @OLD_JOBRCPPROC=[D].[JOBRCPPROC] ,
               @OLD_JOBRCPSTARTTIME=[D].[JOBRCPSTARTTIME] ,
               @OLD_JOBRCPENDTIME=[D].[JOBRCPENDTIME] ,
               @OLD_JOBBCHTOTAL=[D].[JOBBCHTOTAL] ,
               @OLD_JOBBCHERR=[D].[JOBBCHERR] ,
               @OLD_JOBBCHSCH=[D].[JOBBCHSCH] ,
               @OLD_JOBBCHPROC=[D].[JOBBCHPROC] ,
               @OLD_JOBBCHSTARTTIME=[D].[JOBBCHSTARTTIME] ,
               @OLD_JOBBCHENDTIME=[D].[JOBBCHENDTIME] ,
               @OLD_JOBREPLYSENT=[D].[JOBREPLYSENT] ,
               @OLD_JOBREPLYSENTTIME=[D].[JOBREPLYSENTTIME]
            FROM [DELETED] AS [D] WHERE [D].[JOB_ID]=@NEW_JOB_ID;

           IF
               (@NEW_JOBSTATUS <> @OLD_JOBSTATUS AND (@NEW_JOBSTATUS IS NOT NULL AND (( @NEW_JOBSTATUS % 100)>=40 AND ( @NEW_JOBSTATUS % 100)<=49)) AND
                (@OLD_JOBSTATUS IS NULL OR (@OLD_JOBSTATUS IS NOT NULL AND ((@OLD_JOBSTATUS%100)<40 OR (@OLD_JOBSTATUS%100)>49))))
               OR (@NEW_JOBBCHERR > @OLD_JOBBCHERR AND @NEW_JOBBCHERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49))
               OR (@NEW_JOBRCPERR > @OLD_JOBRCPERR AND @NEW_JOBRCPERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49)) 
               OR (@NEW_JOBTRNERR > @OLD_JOBTRNERR AND @NEW_JOBTRNERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49)) 
               OR (@NEW_JOBTRNWIP > @OLD_JOBTRNWIP AND @NEW_JOBTRNWIP > 0 AND @NEW_JOBSTATUS < 290 AND ((@NEW_JOBSTATUS %100 )<40 OR (@NEW_JOBSTATUS % 100)>49)) 
               OR (@NEW_JOBTRNTOTAL = (@NEW_JOBTRNPROC + @NEW_JOBTRNWIP ) AND @NEW_JOBTRNTOTAL > 0 AND @NEW_JOBTRNWIP > 0)
               OR (@OLD_JOBRCPTOTAL < 1 AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBSTATUS < 300 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1)
               OR (@OLD_JOBBCHTOTAL < 1 AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBSTATUS < 400 AND ((@NEW_JOBSTATUS %100 )<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1) 
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 
                  AND (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0) 
               OR (@OLD_JOBSTATUS <> 416 AND @NEW_JOBTRNTOTAL <> 0 AND @NEW_JOBTRNSCH <> 0 AND @NEW_JOBTRNERR = 0 AND @NEW_JOBTRNTOTAL =(@NEW_JOBTRNPROC + @NEW_JOBTRNSCH )) 

               OR (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL)
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 
                  AND (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  
               
               OR (@NEW_JOBTRNTOTAL = (@NEW_JOBTRNPROC + @NEW_JOBTRNWIP ) AND @NEW_JOBTRNTOTAL > 0 AND @NEW_JOBTRNWIP > 0)
               OR (@NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0)

               OR (@NEW_JOBSTATUS = 211 AND @NEW_JOBTRNSTARTTIME IS NULL)

               OR (@NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0)

               OR (@NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0) 

               OR (@NEW_JOBSTATUS = 311 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBRCPSTARTTIME IS NULL)
               
               OR (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL AND @NEW_JOBRCPENDTIME IS NULL)
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 
                   AND (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  
               OR (@NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0) 
               
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0) 
               OR (@NEW_JOBSTATUS = 411 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBBCHSTARTTIME IS NULL)
               OR (@OLD_JOBBCHTOTAL < 1 AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBSTATUS < 400 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1) 
               
               OR (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL AND @NEW_JOBBCHENDTIME IS NULL)
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0) 
               OR (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 
                  AND (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  

               OR ( @NEW_JOBREPLYSENT = 1 AND @NEW_JOBREPLYSENT <> @OLD_JOBREPLYSENT ) 
			   BEGIN
               IF (@OLD_JOBSTATUS <> 416 AND @NEW_JOBTRNTOTAL <> 0 AND @NEW_JOBTRNSCH <> 0 AND @NEW_JOBTRNERR = 0 AND @NEW_JOBTRNTOTAL =(@NEW_JOBTRNPROC + @NEW_JOBTRNSCH )) 
			   BEGIN
                UPDATE [BCHS] SET [BCHS].BCHSTARTINGTIME = '2000-01-01 14:00:00.000' from (Select BCH_ID,JOB_ID FROM [BCHS_RCPS]) a where a.JOB_ID = @NEW_JOB_ID AND a.BCH_ID = [BCHS].BCH_ID AND [BCHS].BCHNAME = 'AWDFileCopy'
	           END
			   END
            UPDATE [JOBS] SET
               @NEW_JOBSTATUS=CASE
                   WHEN (@NEW_JOBBCHERR > @OLD_JOBBCHERR AND @NEW_JOBBCHERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49))
                      THEN 441
                   WHEN (@NEW_JOBRCPERR > @OLD_JOBRCPERR AND @NEW_JOBRCPERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49)) 
                      THEN 341
                   WHEN (@NEW_JOBTRNERR > @OLD_JOBTRNERR AND @NEW_JOBTRNERR > 0 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49)) 
                      THEN 241
                   WHEN (@NEW_JOBTRNTOTAL > @OLD_JOBTRNTOTAL AND @NEW_JOBSTATUS < 240 AND @NEW_JOBTRNSTARTTIME IS NULL AND ((@NEW_JOBSTATUS %100 )<40 OR (@NEW_JOBSTATUS % 100)>49)) 
                      THEN 211
                   WHEN (@NEW_JOBTRNWIP > @OLD_JOBTRNWIP AND @NEW_JOBTRNWIP > 0 AND @NEW_JOBSTATUS < 290 AND ((@NEW_JOBSTATUS %100 )<40 OR (@NEW_JOBSTATUS % 100)>49)) 
                      THEN 290
                   WHEN (@NEW_JOBTRNTOTAL = (@NEW_JOBTRNPROC + @NEW_JOBTRNWIP ) AND @NEW_JOBTRNTOTAL > 0 AND @NEW_JOBTRNWIP > 0)
                      THEN 290
                   WHEN (@OLD_JOBRCPTOTAL < 1 AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBSTATUS < 300 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1)
                      THEN 311
                   WHEN (@OLD_JOBBCHTOTAL < 1 AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBSTATUS < 400 AND ((@NEW_JOBSTATUS %100 )<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1) 
                      THEN 411 
--                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 AND 
--                        (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0) 
                   WHEN (@NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 AND @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0 )

                      THEN 999 
                   WHEN (@OLD_JOBSTATUS <> 416 AND @NEW_JOBTRNTOTAL <> 0 AND @NEW_JOBTRNSCH <> 0 AND @NEW_JOBTRNERR = 0 AND @NEW_JOBTRNTOTAL =(@NEW_JOBTRNPROC + @NEW_JOBTRNSCH )) 
                      THEN 416
                   WHEN (@NEW_JOBSTATUS <> @OLD_JOBSTATUS AND (@NEW_JOBSTATUS IS NOT NULL AND (( @NEW_JOBSTATUS % 100)>=40 AND ( @NEW_JOBSTATUS % 100)<=49)) AND
                    (@OLD_JOBSTATUS IS NULL OR (@OLD_JOBSTATUS IS NOT NULL AND ((@OLD_JOBSTATUS%100)<40 OR (@OLD_JOBSTATUS%100)>49))))
                      THEN @NEW_JOBSTATUS
                   ELSE @NEW_JOBSTATUS END,
               @NEW_JOBENDTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL)
                      THEN (GETUTCDATE())
                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 AND 
                        (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBENDTIME END,
               @NEW_JOBTRNSCH=CASE 
                   WHEN (@NEW_JOBTRNTOTAL = (@NEW_JOBTRNPROC + @NEW_JOBTRNWIP ) AND @NEW_JOBTRNTOTAL > 0 AND @NEW_JOBTRNWIP > 0)
                      THEN 0
                   WHEN (@NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0)
                      THEN 0
                   ELSE @NEW_JOBTRNSCH END ,
               @NEW_JOBTRNSTARTTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 211 AND @NEW_JOBTRNSTARTTIME IS NULL)
                      THEN (GETUTCDATE()) 
                   ELSE @NEW_JOBTRNSTARTTIME END,
               @NEW_JOBTRNENDTIME=CASE
                   WHEN (@NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0)
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBTRNENDTIME END,
               @NEW_JOBRCPSCH=CASE 
                   WHEN (@NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0) 
                      THEN 0
                   ELSE @NEW_JOBRCPSCH END,
               @NEW_JOBRCPSTARTTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 311 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBRCPSTARTTIME IS NULL)
                      THEN (GETUTCDATE())
                   WHEN (@OLD_JOBRCPTOTAL < 1 AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBSTATUS < 300 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1)
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBRCPSTARTTIME END,
               @NEW_JOBRCPENDTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL AND @NEW_JOBRCPENDTIME IS NULL)
                      THEN (GETUTCDATE())
                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 AND 
                        (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  
                      THEN (GETUTCDATE())
                   WHEN (@NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0) 
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBRCPENDTIME END,                        
               @NEW_JOBBCHSCH=CASE 
                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0) 
                      THEN 0
                   ELSE @NEW_JOBBCHSCH END,
               @NEW_JOBBCHSTARTTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 411 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBBCHSTARTTIME IS NULL)
                      THEN (GETUTCDATE())
                   WHEN (@OLD_JOBBCHTOTAL < 1 AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBSTATUS < 400 AND ((@NEW_JOBSTATUS % 100)<40 OR (@NEW_JOBSTATUS % 100)>49) AND @NEW_JOBTRNWIP < 1) 
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBBCHSTARTTIME END,
               @NEW_JOBBCHENDTIME=CASE 
                   WHEN (@NEW_JOBSTATUS = 999 AND @OLD_JOBSTATUS <> @NEW_JOBSTATUS AND @NEW_JOBENDTIME IS NULL AND @NEW_JOBBCHENDTIME IS NULL)
                      THEN (GETUTCDATE())
                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0) 
                      THEN (GETUTCDATE())
                   WHEN (@NEW_JOBBCHTOTAL = @NEW_JOBBCHPROC AND @NEW_JOBBCHTOTAL > 0 AND @NEW_JOBRCPTOTAL = @NEW_JOBRCPPROC AND @NEW_JOBRCPTOTAL > 0 AND @NEW_JOBTRNTOTAL = @NEW_JOBTRNPROC AND @NEW_JOBTRNTOTAL > 0 AND 
                        (@NEW_JOBBCHPROC <> @OLD_JOBBCHPROC OR @NEW_JOBRCPPROC <> @OLD_JOBRCPPROC OR @NEW_JOBTRNPROC <> @OLD_JOBTRNPROC ) AND @NEW_JOBSTATUS < 900 AND @NEW_JOBSTATUS > 0)  
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBBCHENDTIME END,
               @NEW_JOBREPLYSENTTIME=CASE 
                   WHEN ( @NEW_JOBREPLYSENT = 1 AND @NEW_JOBREPLYSENT <> @OLD_JOBREPLYSENT ) 
                      THEN (GETUTCDATE())
                   ELSE @NEW_JOBREPLYSENTTIME END,                        
               [JOBSTATUS]=@NEW_JOBSTATUS,
               [JOBENDTIME]=@NEW_JOBENDTIME,
               [JOBERR_ID]=@NEW_JOBERR_ID,
               [JOBTRNTOTAL]=@NEW_JOBTRNTOTAL,
               [JOBTRNWIP]=@NEW_JOBTRNWIP,
               [JOBTRNERR]=@NEW_JOBTRNERR,
               [JOBTRNSCH]=@NEW_JOBTRNSCH,
               [JOBTRNPROC]=@NEW_JOBTRNPROC ,
               [JOBTRNSTARTTIME]=@NEW_JOBTRNSTARTTIME,
               [JOBTRNENDTIME]=@NEW_JOBTRNENDTIME,
               [JOBRCPTOTAL]=@NEW_JOBRCPTOTAL,
               [JOBRCPERR]=@NEW_JOBRCPERR,
               [JOBRCPSCH]=@NEW_JOBRCPSCH,
               [JOBRCPPROC]=@NEW_JOBRCPPROC,
               [JOBRCPSTARTTIME]=@NEW_JOBRCPSTARTTIME,
               [JOBRCPENDTIME]=@NEW_JOBRCPENDTIME,
               [JOBBCHTOTAL]=@NEW_JOBBCHTOTAL,
               [JOBBCHERR]=@NEW_JOBBCHERR,
               [JOBBCHSCH]=@NEW_JOBBCHSCH,
               [JOBBCHPROC]=@NEW_JOBBCHPROC,
               [JOBBCHSTARTTIME]=@NEW_JOBBCHSTARTTIME,
               [JOBBCHENDTIME]=@NEW_JOBBCHENDTIME,
               [JOBREPLYSENT]=@NEW_JOBREPLYSENT,
               [JOBREPLYSENTTIME]=@NEW_JOBREPLYSENTTIME
         FROM [JOBS]
         WHERE [JOBS].[JOB_ID] = @NEW_JOB_ID 

         FETCH NEXT FROM JOBS_AUPD_TRG_CUR INTO
            @NEW_JOB_ID , 
            @NEW_JOBSTATUS , 
            @NEW_JOBENDTIME , 
            @NEW_JOBERR_ID , 
            @NEW_JOBTRNTOTAL , 
            @NEW_JOBTRNWIP , 
            @NEW_JOBTRNERR , 
            @NEW_JOBTRNSCH ,
            @NEW_JOBTRNPROC ,
            @NEW_JOBTRNSTARTTIME , 
            @NEW_JOBTRNENDTIME , 
            @NEW_JOBRCPTOTAL , 
            @NEW_JOBRCPERR , 
            @NEW_JOBRCPSCH ,
            @NEW_JOBRCPPROC ,
            @NEW_JOBRCPSTARTTIME , 
            @NEW_JOBRCPENDTIME , 
            @NEW_JOBBCHTOTAL , 
            @NEW_JOBBCHERR , 
            @NEW_JOBBCHSCH ,
            @NEW_JOBBCHPROC ,
            @NEW_JOBBCHSTARTTIME , 
            @NEW_JOBBCHENDTIME , 
            @NEW_JOBREPLYSENT ,
            @NEW_JOBREPLYSENTTIME 
      END
      CLOSE JOBS_AUPD_TRG_CUR
      DEALLOCATE JOBS_AUPD_TRG_CUR
   END
END
